<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n de Aportes y Donaciones - UCLA</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Header Institucional -->
    <div class="header">
        <h1>üè´ UCLA - Sistema de Gesti√≥n de Aportes y Donaciones</h1>
        <p>Barquisimeto, Venezuela</p>
    </div>

    <div class="container">
        <!-- SECCI√ìN: INICIO (Admin) -->
        <section id="dashboard" class="section active">
            <div class="breadcrumb">
                <strong>üìä Tablero de Control</strong>
            </div>

            <div class="alert alert-info" id="alertContainer"></div>

            <div class="btn-group" style="justify-content: flex-start; margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="app.irCrearCampa√±a()">
                    ‚ûï Crear Campa√±a
                </button>
                <button class="btn btn-secondary" onclick="app.irVistaParticipante()">
                    üë• Secci√≥n Participante
                </button>
            </div>

            <!-- Estad√≠sticas -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="statActivas">0</div>
                    <div class="stat-label">Campa√±as Activas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statCompletadas">0</div>
                    <div class="stat-label">Campa√±as Completadas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statTotalAportes">0</div>
                    <div class="stat-label">Total de Aportes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statTotalRecaudado">$0</div>
                    <div class="stat-label">Dinero Recaudado</div>
                </div>
            </div>

            <!-- Tabla de Campa√±as -->
            <div class="card">
                <h2>üìã Campa√±as Activas</h2>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Objetivo</th>
                            <th>Recaudado</th>
                            <th>%</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tableCampanas">
                        <tr><td colspan="6" style="text-align: center; color: var(--text-light);">No hay campa√±as registradas</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- SECCI√ìN: Crear Campa√±a -->
        <section id="crearCampa√±a" class="section">
            <div class="breadcrumb">
                <a onclick="app.irDashboard()">‚Üê Volver al Tablero</a> / <strong>Crear Nueva Campa√±a</strong>
            </div>

            <div class="card">
                <h2>üìù Crear Nueva Campa√±a</h2>

                <div id="alertContainer2"></div>

                <form id="formCampa√±a">
                    <div class="form-group">
                        <label>Nombre de la Campa√±a *</label>
                        <input type="text" id="campNombre" required placeholder="Ej: Compra de Mouses para Laboratorio">
                    </div>

                    <div class="form-group">
                        <label>Descripci√≥n *</label>
                        <textarea id="campDescripcion" required placeholder="Describa el prop√≥sito de la campa√±a..."></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Monto Objetivo ($) *</label>
                            <input type="number" id="campMontoObjetivo" required min="0.01" step="0.01" placeholder="Ej: 500">
                        </div>

                        <div class="form-group">
                            <label>Fecha de Inicio *</label>
                            <input type="date" id="campFechaInicio" required>
                        </div>

                        <div class="form-group">
                            <label>Fecha de Cierre *</label>
                            <input type="date" id="campFechaCierre" required>
                        </div>
                    </div>

                    <div class="info-box">
                        <strong>‚ÑπÔ∏è Estado Inicial:</strong> ACTIVA
                        <p>La campa√±a se mantendr√° activa hasta su fecha de cierre o hasta que el monto objetivo sea alcanzado autom√°ticamente.</p>
                    </div>

                    <div class="btn-group">
                        <button type="submit" class="btn btn-success">‚úÖ Crear Campa√±a</button>
                        <button type="button" class="btn btn-secondary" onclick="app.irDashboard()">‚ùå Cancelar</button>
                    </div>
                </form>
            </div>
        </section>

        <!-- SECCI√ìN: Detalle de Campa√±a -->
        <section id="detalleCampa√±a" class="section">
            <div class="breadcrumb">
                <a onclick="app.irDashboard()">‚Üê Volver al Tablero</a> / <strong id="detalleTitulo">Detalle de Campa√±a</strong>
            </div>

            <div class="card">
                <h3 id="detalleNombre"></h3>

                <!-- M√©tricas -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="detalleObjetivo">$0</div>
                        <div class="stat-label">Objetivo</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="detalleRecaudado">$0</div>
                        <div class="stat-label">Recaudado</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="detallePorcentaje">0%</div>
                        <div class="stat-label">Avance</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="detalleAportantes">0</div>
                        <div class="stat-label">Aportantes</div>
                    </div>
                </div>

                <!-- Barra de Progreso -->
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>

                <!-- Mayor Aportante -->
                <h3>üèÜ Mayor Aportante</h3>
                <div class="info-box">
                    <p><strong>C√©dula:</strong> <span id="mayorAportanteCedula">N/A</span></p>
                    <p><strong>Monto:</strong> <span id="mayorAportanteMonto">$0</span></p>
                </div>

                <!-- Lista de Aportes -->
                <h3>üìä Lista de Aportes Recientes</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>C√©dula</th>
                            <th>Monto</th>
                            <th>Fecha</th>
                        </tr>
                    </thead>
                    <tbody id="tableAportes">
                        <tr><td colspan="3" style="text-align: center; color: var(--text-light);">Sin aportes registrados</td></tr>
                    </tbody>
                </table>

                <!-- Acciones -->
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="app.exportarReporte()">üìÑ Exportar Reporte</button>
                    <button class="btn btn-danger" id="btnCerrarCampa√±a" onclick="app.mostrarModalCerrar()">üîí Cerrar Campa√±a</button>
                    <button class="btn btn-secondary" id="btnEditarCampa√±a" onclick="app.irEditarCampa√±a()">‚úèÔ∏è Editar</button>
                </div>
            </div>
        </section>

        <!-- SECCI√ìN: Editar Campa√±a -->
        <section id="editarCampa√±a" class="section">
            <div class="breadcrumb">
                <a onclick="app.irDashboard()">‚Üê Volver al Tablero</a> / <strong>Editar Campa√±a</strong>
            </div>

            <div class="card">
                <h2>‚úèÔ∏è Editar Campa√±a</h2>

                <div id="alertContainer3"></div>

                <form id="formEditar">
                    <div class="form-group">
                        <label>Nombre de la Campa√±a *</label>
                        <input type="text" id="editNombre" required>
                    </div>

                    <div class="form-group">
                        <label>Descripci√≥n *</label>
                        <textarea id="editDescripcion" required></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Monto Objetivo ($) *</label>
                            <input type="number" id="editMontoObjetivo" required min="0.01" step="0.01">
                        </div>

                        <div class="form-group">
                            <label>Fecha de Inicio *</label>
                            <input type="date" id="editFechaInicio" required>
                        </div>

                        <div class="form-group">
                            <label>Fecha de Cierre *</label>
                            <input type="date" id="editFechaCierre" required>
                        </div>
                    </div>

                    <div class="alert alert-warning">
                        ‚ö†Ô∏è <strong>Importante:</strong> Solo se pueden editar campa√±as que no hayan recibido aportes.
                    </div>

                    <div class="btn-group">
                        <button type="submit" class="btn btn-success">‚úÖ Guardar Cambios</button>
                        <button type="button" class="btn btn-secondary" onclick="app.irDetalleCampa√±a()">‚ùå Cancelar</button>
                    </div>
                </form>
            </div>
        </section>

        <!-- SECCI√ìN: Participante (Registrar Aporte) -->
        <section id="vistaParticipante" class="section">
            <div class="breadcrumb">
                <a onclick="app.irDashboard()">‚Üê Volver</a> / <strong>Registrar Mi Aporte</strong>
            </div>

            <div id="alertContainer4"></div>

            <!-- Seleccionar Campa√±a -->
            <div class="card">
                <h2>üéØ Seleccionar Campa√±a</h2>
                <select id="selectCampa√±a" onchange="app.seleccionarCampa√±a()" class="form-group" style="padding: 12px; font-size: 14px;">
                    <option value="">-- Seleccione una campa√±a --</option>
                </select>
            </div>

            <!-- Formulario de Aporte -->
            <div class="card" id="formularioAporte" style="display: none;">
                <h2>üí∞ Registrar Mi Aporte</h2>

                <div class="info-box">
                    <strong>Campa√±a Seleccionada:</strong> <span id="aporteNombreCampa√±a"></span>
                </div>

                <form id="formAporte">
                    <div class="form-group">
                        <label>C√©dula de Identidad *</label>
                        <input type="text" id="aporteCedula" required placeholder="Ej: V-12345678">
                    </div>

                    <div class="form-group">
                        <label>Monto a Aportar ($) *</label>
                        <input type="number" id="aporteMonto" required min="0.01" step="0.01" placeholder="Ej: 50">
                    </div>

                    <div class="btn-group">
                        <button type="submit" class="btn btn-success">‚úÖ Registrar Aporte</button>
                        <button type="button" class="btn btn-secondary" onclick="app.irVistaParticipante()">‚ùå Cancelar</button>
                    </div>
                </form>
            </div>

            <!-- Recibo de Aporte -->
            <div id="recibo" style="display: none;">
                <div class="receipt">
                    <div class="receipt-title">‚úÖ ¬°Gracias por su Aporte!</div>
                    <div class="receipt-item">
                        <strong>C√©dula:</strong> <span id="reciboCedula"></span>
                    </div>
                    <div class="receipt-item">
                        <strong>Monto:</strong> <span id="reciboMonto"></span>
                    </div>
                    <div class="receipt-item">
                        <strong>Campa√±a:</strong> <span id="reciboCampa√±a"></span>
                    </div>
                    <div class="receipt-item">
                        <strong>Fecha:</strong> <span id="reciboFecha"></span>
                    </div>
                    <button class="btn btn-primary" onclick="app.irVistaParticipante()" style="margin-top: 20px;">Hacer Otro Aporte</button>
                </div>
            </div>
        </section>
    </div>

    <!-- Modal de Confirmaci√≥n -->
    <div id="modalCerrar" class="modal">
        <div class="modal-content">
            <div class="modal-header">‚ö†Ô∏è Confirmar Cierre de Campa√±a</div>
            <div class="modal-body">
                ¬øEst√° seguro de que desea cerrar esta campa√±a? No se podr√°n recibir m√°s fondos despu√©s de esto.
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="app.cerrarCampa√±a()">S√≠, Cerrar</button>
                <button class="btn btn-secondary" onclick="app.cerrarModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // ============ MODELO: Campa√±a ============
        class Campa√±a {
            constructor(datos) {
                this.id = Date.now();
                this.nombre = datos.nombre;
                this.descripcion = datos.descripcion;
                this.montoObjetivo = parseFloat(datos.montoObjetivo);
                this.montoRecaudado = 0;
                this.estado = 'ACTIVA';
                this.fechaInicio = new Date(datos.fechaInicio);
                this.fechaCierre = new Date(datos.fechaCierre);
                this.aportes = [];
            }

            agregarAporte(cedula, monto) {
                const aporte = {
                    cedula,
                    monto: parseFloat(monto),
                    fecha: new Date()
                };
                this.aportes.push(aporte);
                this.montoRecaudado += aporte.monto;
                this.verificarCompleci√≥n();
            }

            verificarCompleci√≥n() {
                if (this.montoRecaudado >= this.montoObjetivo) {
                    this.estado = 'COMPLETADA';
                }
            }

            estaActiva() {
                const hoy = new Date();
                return this.estado === 'ACTIVA' && 
                       hoy >= this.fechaInicio && 
                       hoy <= this.fechaCierre;
            }

            obtenerMetricas() {
                const porcentaje = (this.montoRecaudado / this.montoObjetivo * 100).toFixed(2);
                const mayorAportante = this.aportes.length > 0
                    ? this.aportes.reduce((prev, current) => 
                        prev.monto > current.monto ? prev : current)
                    : null;

                return {
                    porcentaje,
                    mayorAportante,
                    aportantes: this.aportes.length
                };
            }
        }

        // ============ MODELO: Sistema ============
        class SistemaAportes {
            constructor() {
                this.campa√±as = [];
                this.campa√±aActual = null;
            }

            crearCampa√±a(datos) {
                // Validaciones
                if (!datos.nombre || datos.nombre.trim() === '') {
                    return { error: 'El nombre de la campa√±a es obligatorio.' };
                }
                if (!datos.descripcion || datos.descripcion.trim() === '') {
                    return { error: 'La descripci√≥n es obligatoria.' };
                }
                if (parseFloat(datos.montoObjetivo) <= 0) {
                    return { error: 'El monto objetivo debe ser mayor a 0.' };
                }

                const inicio = new Date(datos.fechaInicio);
                const cierre = new Date(datos.fechaCierre);
                const hoy = new Date();

                if (inicio < hoy) {
                    return { error: 'La fecha de inicio debe ser igual o posterior a hoy.' };
                }
                if (cierre <= inicio) {
                    return { error: 'La fecha de cierre debe ser posterior a la fecha de inicio.' };
                }

                const campa√±a = new Campa√±a(datos);
                this.campa√±as.push(campa√±a);
                return { success: true, campa√±a };
            }

            obtenerResumen() {
                const activas = this.campa√±as.filter(c => c.estado === 'ACTIVA').length;
                const completadas = this.campa√±as.filter(c => c.estado === 'COMPLETADA').length;
                const totalAportes = this.campa√±as.reduce((sum, c) => sum + c.aportes.length, 0);
                const totalRecaudado = this.campa√±as.reduce((sum, c) => sum + c.montoRecaudado, 0);

                return { activas, completadas, totalAportes, totalRecaudado };
            }

            obtenerCampa√±asActivas() {
                return this.campa√±as.filter(c => c.estado === 'ACTIVA');
            }

            obtenerCampa√±a(id) {
                return this.campa√±as.find(c => c.id == id);
            }

            editarCampa√±a(id, datos) {
                const campa√±a = this.obtenerCampa√±a(id);
                if (!campa√±a) return { error: 'Campa√±a no encontrada.' };

                if (campa√±a.aportes.length > 0) {
                    return { error: 'No se puede editar una campa√±a con fondos ya recaudados.' };
                }

                // Validaciones
                if (!datos.nombre || datos.nombre.trim() === '') {
                    return { error: 'El nombre es obligatorio.' };
                }
                if (parseFloat(datos.montoObjetivo) <= 0) {
                    return { error: 'El monto debe ser mayor a 0.' };
                }

                const cierre = new Date(datos.fechaCierre);
                const inicio = new Date(datos.fechaInicio);

                if (cierre <= inicio) {
                    return { error: 'La fecha de cierre debe ser posterior a la de inicio.' };
                }

                campa√±a.nombre = datos.nombre;
                campa√±a.descripcion = datos.descripcion;
                campa√±a.montoObjetivo = parseFloat(datos.montoObjetivo);
                campa√±a.fechaInicio = inicio;
                campa√±a.fechaCierre = cierre;

                return { success: true };
            }

            cerrarCampa√±a(id) {
                const campa√±a = this.obtenerCampa√±a(id);
                if (!campa√±a) return { error: 'Campa√±a no encontrada.' };

                if (campa√±a.estado === 'COMPLETADA' || campa√±a.estado === 'CERRADA') {
                    return { error: 'Esta campa√±a ya est√° cerrada.' };
                }

                campa√±a.estado = 'CERRADA';
                return { success: true };
            }

            registrarAporte(campa√±aId, cedula, monto) {
                const campa√±a = this.obtenerCampa√±a(campa√±aId);
                if (!campa√±a) return { error: 'Campa√±a no encontrada.' };

                if (!campa√±a.estaActiva()) {
                    return { error: 'Esta campa√±a ya no acepta aportes.' };
                }

                if (!cedula || cedula.trim() === '') {
                    return { error: 'La c√©dula es obligatoria.' };
                }

                if (parseFloat(monto) <= 0) {
                    return { error: 'El monto debe ser mayor a 0.' };
                }

                campa√±a.agregarAporte(cedula, monto);
                return { success: true };
            }
        }

        // ============ CONTROLADOR ============
        class Controlador {
            constructor() {
                this.sistema = new SistemaAportes();
                this.campa√±aEnEdici√≥n = null;
                this.inicializarEventos();
                this.establecerFechasMinimas();
            }

            inicializarEventos() {
                document.getElementById('formCampa√±a').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.crearCampa√±a();
                });

                document.getElementById('formEditar').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.guardarEdici√≥n();
                });

                document.getElementById('formAporte').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.registrarAporte();
                });
            }

            establecerFechasMinimas() {
                const hoy = new Date().toISOString().split('T')[0];
                document.getElementById('campFechaInicio').setAttribute('min', hoy);
                document.getElementById('editFechaInicio').setAttribute('min', hoy);
            }

            crearCampa√±a() {
                const datos = {
                    nombre: document.getElementById('campNombre').value,
                    descripcion: document.getElementById('campDescripcion').value,
                    montoObjetivo: document.getElementById('campMontoObjetivo').value,
                    fechaInicio: document.getElementById('campFechaInicio').value,
                    fechaCierre: document.getElementById('campFechaCierre').value
                };

                const resultado = this.sistema.crearCampa√±a(datos);

                if (resultado.error) {
                    this.mostrarAlerta(resultado.error, 'error', 'alertContainer2');
                } else {
                    this.mostrarAlerta('‚úÖ Campa√±a creada exitosamente', 'success', 'alertContainer2');
                    setTimeout(() => this.irDashboard(), 1500);
                }
            }

            guardarEdici√≥n() {
                const datos = {
                    nombre: document.getElementById('editNombre').value,
                    descripcion: document.getElementById('editDescripcion').value,
                    montoObjetivo: document.getElementById('editMontoObjetivo').value,
                    fechaInicio: document.getElementById('editFechaInicio').value,
                    fechaCierre: document.getElementById('editFechaCierre').value
                };

                const resultado = this.sistema.editarCampa√±a(this.campa√±aEnEdici√≥n.id, datos);

                if (resultado.error) {
                    this.mostrarAlerta(resultado.error, 'error', 'alertContainer3');
                } else {
                    this.mostrarAlerta('‚úÖ Campa√±a actualizada', 'success', 'alertContainer3');
                    setTimeout(() => this.irDetalleCampa√±a(), 1500);
                }
            }

            registrarAporte() {
                const select = document.getElementById('selectCampa√±a');
                const campa√±aId = select.value;
                const cedula = document.getElementById('aporteCedula').value;
                const monto = document.getElementById('aporteMonto').value;

                const resultado = this.sistema.registrarAporte(campa√±aId, cedula, monto);

                if (resultado.error) {
                    this.mostrarAlerta(resultado.error, 'error', 'alertContainer4');
                } else {
                    const campa√±a = this.sistema.obtenerCampa√±a(campa√±aId);
                    this.mostrarRecibo(cedula, monto, campa√±a.nombre);
                }
            }

            mostrarRecibo(cedula, monto, nombreCampa√±a) {
                document.getElementById('reciboCedula').textContent = cedula;
                document.getElementById('reciboMonto').textContent = '$' + parseFloat(monto).toFixed(2);
                document.getElementById('reciboCampa√±a').textContent = nombreCampa√±a;
                document.getElementById('reciboFecha').textContent = new Date().toLocaleDateString('es-ES');

                document.getElementById('formularioAporte').style.display = 'none';
                document.getElementById('recibo').style.display = 'block';
                document.getElementById('selectCampa√±a').value = '';
            }

            actualizarDashboard() {
                const resumen = this.sistema.obtenerResumen();
                document.getElementById('statActivas').textContent = resumen.activas;
                document.getElementById('statCompletadas').textContent = resumen.completadas;
                document.getElementById('statTotalAportes').textContent = resumen.totalAportes;
                document.getElementById('statTotalRecaudado').textContent = '$' + resumen.totalRecaudado.toFixed(2);

                this.actualizarTablaCampa√±as();
            }

            actualizarTablaCampa√±as() {
                const tabla = document.getElementById('tableCampanas');
                const campa√±as = this.sistema.campa√±as;

                if (campa√±as.length === 0) {
                    tabla.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-light);">No hay campa√±as registradas</td></tr>';
                    return;
                }

                tabla.innerHTML = campa√±as.map(c => `
                    <tr>
                        <td><strong>${c.nombre}</strong></td>
                        <td>$${c.montoObjetivo.toFixed(2)}</td>
                        <td>$${c.montoRecaudado.toFixed(2)}</td>
                        <td>${(c.montoRecaudado / c.montoObjetivo * 100).toFixed(0)}%</td>
                        <td>
                            <span class="badge ${c.estado === 'ACTIVA' ? 'badge-success' : c.estado === 'COMPLETADA' ? 'badge-info' : 'badge-danger'}">
                                ${c.estado}
                            </span>
                        </td>
                        <td>
                            <div class="action-icons">
                                <button class="icon-btn" title="Ver Detalle" onclick="app.irDetalleCampa√±a(${c.id})">üëÅÔ∏è</button>
                                <button class="icon-btn ${c.aportes.length > 0 ? 'disabled' : ''}" 
                                    title="${c.aportes.length > 0 ? 'No se puede editar con aportes' : 'Editar'}"
                                    onclick="app.irEditarCampa√±a(${c.id})" 
                                    ${c.aportes.length > 0 ? 'disabled' : ''}>‚úèÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }

            actualizarDetalleCampa√±a(id) {
                const campa√±a = this.sistema.obtenerCampa√±a(id);
                if (!campa√±a) return;

                this.campa√±aEnEdici√≥n = campa√±a;
                const metricas = campa√±a.obtenerMetricas();

                document.getElementById('detalleNombre').textContent = campa√±a.nombre;
                document.getElementById('detalleObjetivo').textContent = '$' + campa√±a.montoObjetivo.toFixed(2);
                document.getElementById('detalleRecaudado').textContent = '$' + campa√±a.montoRecaudado.toFixed(2);
                document.getElementById('detallePorcentaje').textContent = metricas.porcentaje + '%';
                document.getElementById('detalleAportantes').textContent = metricas.aportantes;

                const progressFill = document.getElementById('progressFill');
                const ancho = Math.min(parseFloat(metricas.porcentaje), 100);
                progressFill.style.width = ancho + '%';
                progressFill.textContent = metricas.porcentaje + '%';

                if (metricas.mayorAportante) {
                    document.getElementById('mayorAportanteCedula').textContent = metricas.mayorAportante.cedula;
                    document.getElementById('mayorAportanteMonto').textContent = '$' + metricas.mayorAportante.monto.toFixed(2);
                } else {
                    document.getElementById('mayorAportanteCedula').textContent = 'N/A';
                    document.getElementById('mayorAportanteMonto').textContent = '$0';
                }

                const tableAportes = document.getElementById('tableAportes');
                if (campa√±a.aportes.length === 0) {
                    tableAportes.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--text-light);">Sin aportes registrados</td></tr>';
                } else {
                    tableAportes.innerHTML = campa√±a.aportes.map(a => `
                        <tr>
                            <td>${a.cedula}</td>
                            <td>$${a.monto.toFixed(2)}</td>
                            <td>${a.fecha.toLocaleDateString('es-ES')}</td>
                        </tr>
                    `).join('');
                }

                const btnCerrar = document.getElementById('btnCerrarCampa√±a');
                const btnEditar = document.getElementById('btnEditarCampa√±a');

                if (campa√±a.estado === 'COMPLETADA' || campa√±a.estado === 'CERRADA') {
                    btnCerrar.disabled = true;
                    btnCerrar.style.opacity = '0.5';
                    btnEditar.disabled = true;
                    btnEditar.style.opacity = '0.5';
                } else {
                    btnCerrar.disabled = false;
                    btnCerrar.style.opacity = '1';
                    btnEditar.disabled = campa√±a.aportes.length > 0;
                    btnEditar.style.opacity = campa√±a.aportes.length > 0 ? '0.5' : '1';
                }
            }

            actualizarCampa√±asParticipante() {
                const select = document.getElementById('selectCampa√±a');
                const campa√±asActivas = this.sistema.campa√±as.filter(c => c.estaActiva());

                select.innerHTML = '<option value="">-- Seleccione una campa√±a --</option>' +
                    campa√±asActivas.map(c => `<option value="${c.id}">${c.nombre}</option>`).join('');
            }

            exportarReporte() {
                if (!this.campa√±aEnEdici√≥n) return;

                const c = this.campa√±aEnEdici√≥n;
                let reporte = 'REPORTE DE CAMPA√ëA\n';
                reporte += '==================\n\n';
                reporte += `Nombre: ${c.nombre}\n`;
                reporte += `Descripci√≥n: ${c.descripcion}\n`;
                reporte += `Objetivo: $${c.montoObjetivo.toFixed(2)}\n`;
                reporte += `Recaudado: $${c.montoRecaudado.toFixed(2)}\n`;
                reporte += `Porcentaje: ${(c.montoRecaudado / c.montoObjetivo * 100).toFixed(2)}%\n`;
                reporte += `Estado: ${c.estado}\n\n`;

                reporte += 'APORTES REGISTRADOS\n';
                reporte += '-------------------\n';
                reporte += 'C√©dula | Monto | Fecha\n';
                c.aportes.forEach(a => {
                    reporte += `${a.cedula} | $${a.monto.toFixed(2)} | ${a.fecha.toLocaleDateString('es-ES')}\n`;
                });

                const blob = new Blob([reporte], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Reporte_${c.nombre}_${new Date().toISOString().split('T')[0]}.txt`;
                a.click();
            }

            mostrarAlerta(mensaje, tipo, contenedor = 'alertContainer') {
                const container = document.getElementById(contenedor);
                container.innerHTML = `<div class="alert alert-${tipo}">${mensaje}</div>`;
                setTimeout(() => {
                    container.innerHTML = '';
                }, 4000);
            }

            mostrarModalCerrar() {
                document.getElementById('modalCerrar').classList.add('active');
            }

            cerrarModal() {
                document.getElementById('modalCerrar').classList.remove('active');
            }

            cerrarCampa√±a() {
                if (!this.campa√±aEnEdici√≥n) return;

                const resultado = this.sistema.cerrarCampa√±a(this.campa√±aEnEdici√≥n.id);
                this.cerrarModal();

                if (resultado.error) {
                    this.mostrarAlerta(resultado.error, 'error');
                } else {
                    this.mostrarAlerta('‚úÖ Campa√±a cerrada', 'success');
                    this.actualizarDetalleCampa√±a(this.campa√±aEnEdici√≥n.id);
                }
            }

            // Navegaci√≥n
            irSecci√≥n(seccionId) {
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.getElementById(seccionId).classList.add('active');
            }

            irDashboard() {
                this.irSecci√≥n('dashboard');
                this.actualizarDashboard();
            }

            irCrearCampa√±a() {
                document.getElementById('formCampa√±a').reset();
                this.irSecci√≥n('crearCampa√±a');
            }

            irDetalleCampa√±a(id = null) {
                if (id) {
                    this.actualizarDetalleCampa√±a(id);
                }
                this.irSecci√≥n('detalleCampa√±a');
            }

            irEditarCampa√±a(id = null) {
                if (id) {
                    const campa√±a = this.sistema.obtenerCampa√±a(id);
                    document.getElementById('editNombre').value = campa√±a.nombre;
                    document.getElementById('editDescripcion').value = campa√±a.descripcion;
                    document.getElementById('editMontoObjetivo').value = campa√±a.montoObjetivo;
                    document.getElementById('editFechaInicio').value = campa√±a.fechaInicio.toISOString().split('T')[0];
                    document.getElementById('editFechaCierre').value = campa√±a.fechaCierre.toISOString().split('T')[0];
                    this.campa√±aEnEdici√≥n = campa√±a;
                }
                this.irSecci√≥n('editarCampa√±a');
            }

            irVistaParticipante() {
                document.getElementById('selectCampa√±a').value = '';
                document.getElementById('formularioAporte').style.display = 'none';
                document.getElementById('recibo').style.display = 'none';
                document.getElementById('formAporte').reset();
                this.actualizarCampa√±asParticipante();
                this.irSecci√≥n('vistaParticipante');
            }

            seleccionarCampa√±a() {
                const select = document.getElementById('selectCampa√±a');
                if (select.value) {
                    const campa√±a = this.sistema.obtenerCampa√±a(select.value);
                    document.getElementById('aporteNombreCampa√±a').textContent = campa√±a.nombre;
                    document.getElementById('formularioAporte').style.display = 'block';
                    document.getElementById('recibo').style.display = 'none';
                    document.getElementById('formAporte').reset();
                } else {
                    document.getElementById('formularioAporte').style.display = 'none';
                }
            }
        }

        // ============ INICIALIZAR ============
        const app = new Controlador();
        app.irDashboard();
    </script>
</body>
</html>